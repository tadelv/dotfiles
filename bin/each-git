#!/usr/bin/env ruby
# for each git repo in a subdirectory ...
require 'optparse'

# use 'each-git -d' to execute commands recursively, i.e. in submodules
params = ARGV.getopts('d')
dirs = Dir[params[:d]? '**/.git' : '*/.git'].map { |gd| File.dirname(gd) }

def prompt
  print ">> "
  gets
end

# ... execute a command given on STDIN
while command = prompt
  dirs.each do |dir|
    begin
      Dir.chdir(dir) do
        puts "~ #{dir}:"
        system command
      end
    rescue Errno::ENOENT => e
      $stderr.puts e.message
    end
  end
end

# (press Ctrl+D to break out of the loop)